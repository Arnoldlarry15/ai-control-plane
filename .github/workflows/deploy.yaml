name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'
    
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'
    
    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > /tmp/kubeconfig
        echo "KUBECONFIG=/tmp/kubeconfig" >> $GITHUB_ENV
    
    - name: Deploy with Helm
      run: |
        helm upgrade --install ai-control-plane \
          ./deployments/helm/ai-control-plane \
          --namespace ai-governance \
          --create-namespace \
          --set image.tag=${{ github.ref_name }} \
          --set secrets.adminApiKey=${{ secrets.ADMIN_API_KEY }} \
          --wait \
          --timeout 10m
    
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/ai-control-plane -n ai-governance
        kubectl get pods -n ai-governance
    
    - name: Run smoke tests
      run: |
        kubectl run smoke-test \
          --image=curlimages/curl:latest \
          --restart=Never \
          --rm \
          -i \
          -n ai-governance \
          -- curl -f http://ai-control-plane/health || exit 1
